<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestor de Ofertas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Se añade Babel para transpilar JSX/TSX en el navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="importmap">
{
  "imports": {
    "recharts": "https://aistudiocdn.com/recharts@^3.3.0",
    "react-dom/client": "https://aistudiocdn.com/react-dom@^19.2.0/client",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "firebase/app": "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js",
    "firebase/firestore": "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js",
    "firebase/analytics": "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js"
  }
}
</script>
</head>
  <body class="bg-gray-100 dark:bg-gray-900">
    <div id="root"></div>
    <script type="text/babel" data-type="module" data-presets="react,typescript">
// --- Inlined from firebase.ts ---
import { initializeApp } from "firebase/app";
import { getFirestore } from "firebase/firestore";
import { getAnalytics } from "firebase/analytics";

const firebaseConfig = {
  apiKey: "AIzaSyDRzm3bvkogl0sfpxmgGGAxcVy7aNrJCI8",
  authDomain: "project-managment-d4a21.firebaseapp.com",
  projectId: "project-managment-d4a21",
  storageBucket: "project-managment-d4a21.firebasestorage.app",
  messagingSenderId: "921399366035",
  appId: "1:921399366035:web:21638be9321e23d6579866",
  measurementId: "G-GLY1NSTK0F"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const analytics = getAnalytics(app);

// --- Inlined from types.ts ---
// Interfaces are globally available within this script block

// --- Inlined from components/icons ---
const PlusIcon = (props) => (
  <svg
    xmlns="http://www.w3.org/2000/svg"
    className="h-6 w-6"
    fill="none"
    viewBox="0 0 24 24"
    stroke="currentColor"
    strokeWidth={2}
    {...props}
  >
    <path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" />
  </svg>
);

const EditIcon = (props) => (
  <svg
    xmlns="http://www.w3.org/2000/svg"
    className="h-6 w-6"
    fill="none"
    viewBox="0 0 24 24"
    stroke="currentColor"
    strokeWidth={2}
    {...props}
  >
    <path strokeLinecap="round" strokeLinejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z" />
  </svg>
);

const CloseIcon = (props) => (
  <svg
    xmlns="http://www.w3.org/2000/svg"
    className="h-6 w-6"
    fill="none"
    viewBox="0 0 24 24"
    stroke="currentColor"
    strokeWidth={2}
    {...props}
  >
    <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
  </svg>
);

const UploadIcon = (props) => (
  <svg
    xmlns="http://www.w3.org/2000/svg"
    className="h-6 w-6"
    fill="none"
    viewBox="0 0 24 24"
    stroke="currentColor"
    strokeWidth={2}
    {...props}
  >
    <path
      strokeLinecap="round"
      strokeLinejoin="round"
      d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
    />
  </svg>
);

const DownloadIcon = (props) => (
  <svg
    xmlns="http://www.w3.org/2000/svg"
    className="h-6 w-6"
    fill="none"
    viewBox="0 0 24 24"
    stroke="currentColor"
    strokeWidth={2}
    {...props}
  >
    <path
      strokeLinecap="round"
      strokeLinejoin="round"
      d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
    />
  </svg>
);

const TrashIcon = (props) => (
  <svg
    xmlns="http://www.w3.org/2000/svg"
    className="h-5 w-5"
    fill="none"
    viewBox="0 0 24 24"
    stroke="currentColor"
    strokeWidth={2}
    {...props}
  >
    <path
      strokeLinecap="round"
      strokeLinejoin="round"
      d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
    />
  </svg>
);

const CogIcon = (props) => (
  <svg
    xmlns="http://www.w3.org/2000/svg"
    className="h-6 w-6"
    fill="none"
    viewBox="0 0 24 24"
    stroke="currentColor"
    strokeWidth={2}
    {...props}
  >
    <path
      strokeLinecap="round"
      strokeLinejoin="round"
      d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z"
    />
    <path
      strokeLinecap="round"
      strokeLinejoin="round"
      d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
    />
  </svg>
);

const SearchIcon = (props) => (
  <svg
    xmlns="http://www.w3.org/2000/svg"
    className="h-6 w-6"
    fill="none"
    viewBox="0 0 24 24"
    stroke="currentColor"
    strokeWidth={2}
    {...props}
  >
    <path
      strokeLinecap="round"
      strokeLinejoin="round"
      d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
    />
  </svg>
);

const FilterClearIcon = (props) => (
  <svg 
    xmlns="http://www.w3.org/2000/svg" 
    fill="none" 
    viewBox="0 0 24 24" 
    strokeWidth={1.5} 
    stroke="currentColor" 
    {...props}
   >
    <path strokeLinecap="round" strokeLinejoin="round" d="M12 3c-1.2 0-2.3.4-3.2 1.1A6.7 6.7 0 005.1 8.3c-.9 1.8-1.1 3.8-1 5.7.2 2.2 1.2 4.3 2.9 5.8 1.7 1.5 3.9 2.3 6.1 2.2 2.2-.1 4.3-.9 5.9-2.4a8.3 8.3 0 002.5-6.1c.1-2.2-.6-4.3-2-6-1.4-1.7-3.4-2.8-5.6-3z" />
    <path strokeLinecap="round" strokeLinejoin="round" d="M14.3 9.7l-4.6 4.6m0-4.6l4.6 4.6" />
  </svg>
);

const GoogleIcon = (props) => (
  <svg viewBox="0 0 48 48" {...props}>
    <path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039L38.804 9.196C34.935 5.644 29.838 4 24 4 12.955 4 4 12.955 4 24s8.955 20 20 20 20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path>
    <path fill="#FF3D00" d="M6.306 14.691c2.242-4.106 6.51-7.094 11.493-7.094 3.059 0 5.842 1.154 7.961 3.039L38.804 9.196C34.935 5.644 29.838 4 24 4 16.29 4 9.47 8.169 6.306 14.691z"></path>
    <path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238c-2.008 1.521-4.508 2.43-7.219 2.43-5.223 0-9.65-3.344-11.303-8H4.645v5.034C8.61 40.584 15.638 44 24 44z"></path>
    <path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.089 5.571l6.19 5.238C44.463 36.173 48 30.453 48 24c0-1.341-.138-2.65-.389-3.917z"></path>
  </svg>
);

const LogoutIcon = (props) => (
  <svg 
    xmlns="http://www.w3.org/2000/svg" 
    className="h-6 w-6" 
    fill="none" 
    viewBox="0 0 24 24" 
    stroke="currentColor" 
    strokeWidth={2}
    {...props}>
    <path strokeLinecap="round" strokeLinejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
  </svg>
);

// --- Inlined from components/Modal.tsx ---
const Modal = ({ isOpen, onClose, title, children }) => {
  if (!isOpen) return null;

  return (
    <div
      className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4"
      onClick={onClose}
    >
      <div
        className="bg-white dark:bg-gray-800 rounded-lg shadow-2xl w-full max-w-2xl transform transition-all"
        onClick={(e) => e.stopPropagation()}
      >
        <div className="flex justify-between items-center p-5 border-b border-gray-200 dark:border-gray-700">
          <h3 className="text-xl font-semibold text-gray-900 dark:text-white">{title}</h3>
          <button
            onClick={onClose}
            className="text-gray-400 bg-transparent hover:bg-gray-200 dark:hover:bg-gray-600 hover:text-gray-900 dark:hover:text-white rounded-lg text-sm p-1.5 ml-auto inline-flex items-center"
          >
            <CloseIcon className="w-5 h-5" />
            <span className="sr-only">Cerrar modal</span>
          </button>
        </div>
        <div className="p-6">
          {children}
        </div>
      </div>
    </div>
  );
};

// --- Inlined from components/AlertDialog.tsx ---
const AlertDialog = ({
  isOpen,
  onClose,
  onConfirm,
  title,
  message,
  isConfirmation,
}) => {
  if (!isOpen) return null;

  const handleConfirm = () => {
    if (onConfirm) {
      onConfirm();
    }
  };

  return (
    <Modal isOpen={isOpen} onClose={onClose} title={title}>
        <div className="space-y-6">
            <p className="text-base leading-relaxed text-gray-600 dark:text-gray-300">
                {message}
            </p>
            <div className="flex items-center justify-end space-x-2 pt-4 border-t border-gray-200 dark:border-gray-600 rounded-b">
                 {isConfirmation ? (
                    <>
                        <button
                            onClick={onClose}
                            type="button"
                            className="text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-blue-300 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-500 dark:hover:text-white dark:hover:bg-gray-600"
                        >
                            Cancelar
                        </button>
                        <button
                            onClick={handleConfirm}
                            type="button"
                            className="text-white bg-red-600 hover:bg-red-700 focus:ring-4 focus:outline-none focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-red-500 dark:hover:bg-red-600"
                        >
                            Confirmar
                        </button>
                    </>
                 ) : (
                    <button
                        onClick={onClose}
                        type="button"
                        className="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700"
                    >
                        De Acuerdo
                    </button>
                 )}
            </div>
        </div>
    </Modal>
  );
};

// --- Inlined from components/Header.tsx ---
const Header = ({ onRegisterClick, onUpdateClick, onImportClick, onExportClick }) => {
  return (
    <header className="bg-white dark:bg-gray-800 shadow-md p-4 mb-8">
      <div className="container mx-auto flex justify-between items-center">
        <h1 className="text-2xl font-bold text-gray-800 dark:text-white">
          Gestor de Ofertas
        </h1>
        <div className="flex items-center space-x-2 sm:space-x-4">
          <button
            onClick={onRegisterClick}
            className="flex items-center bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200"
            aria-label="Registrar nueva oferta"
          >
            <PlusIcon className="w-5 h-5 mr-0 sm:mr-2" />
            <span className="hidden sm:inline">Registrar Oferta</span>
          </button>
          <button
            onClick={onUpdateClick}
            className="flex items-center bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors duration-200"
            aria-label="Actualizar oferta existente"
          >
            <EditIcon className="w-5 h-5 mr-0 sm:mr-2" />
            <span className="hidden sm:inline">Act. Oferta</span>
          </button>
          <button
            onClick={onImportClick}
            className="flex items-center bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-colors duration-200"
            aria-label="Importar ofertas desde archivo CSV"
          >
            <UploadIcon className="w-5 h-5 mr-0 sm:mr-2" />
            <span className="hidden sm:inline">Importar CSV</span>
          </button>
          <button
            onClick={onExportClick}
            className="flex items-center bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition-colors duration-200"
            aria-label="Exportar ofertas a archivo CSV"
          >
            <DownloadIcon className="w-5 h-5 mr-0 sm:mr-2" />
            <span className="hidden sm:inline">Exportar CSV</span>
          </button>
        </div>
      </div>
    </header>
  );
};

// --- Inlined from components/RegisterOfferModal.tsx ---
const InputFieldRegister = ({ label, name, type = 'text', required = false, value, onChange }) => (
    <div>
      <label htmlFor={name} className="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
        {label} {required && <span className="text-red-500">*</span>}
      </label>
      <input
        type={type}
        id={name}
        name={name}
        value={value}
        onChange={onChange}
        required={required}
        className="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"
      />
    </div>
);

const RegisterOfferModal = ({ isOpen, onClose, onSubmit, statuses }) => {
  const { useState, useEffect } = React;
  const getInitialState = () => ({
    id: '',
    estado: '',
    cliente: '',
    destino: '',
    proyecto: '',
    fechaRfq: '',
    responsable: '',
    volPico: '',
    volTot: '',
    sop: '',
    duracion: '',
  });

  const [formData, setFormData] = useState(getInitialState());

  useEffect(() => {
    if (isOpen) {
      setFormData(getInitialState());
    }
  }, [isOpen]);


  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData((prev) => ({ ...prev, [name]: value }));
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!formData.id || !formData.proyecto || !formData.fechaRfq || !formData.responsable) {
        alert("Por favor, rellene los campos obligatorios: Nº Oferta, Proyecto, Fecha RFQ y Responsable.");
        return;
    }
    
    onSubmit({
      id: formData.id,
      estado: formData.estado,
      cliente: formData.cliente,
      destino: formData.destino,
      proyecto: formData.proyecto,
      fechaRfq: formData.fechaRfq,
      responsable: formData.responsable,
      sop: formData.sop,
      duracion: formData.duracion,
      volPico: formData.volPico ? Number(formData.volPico) : undefined,
      volTot: formData.volTot ? Number(formData.volTot) : undefined,
    });
    onClose();
  };


  return (
    <Modal isOpen={isOpen} onClose={onClose} title="Registrar Nueva Oferta">
      <form onSubmit={handleSubmit} className="space-y-4">
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <InputFieldRegister label="Nº Oferta" name="id" required value={formData.id} onChange={handleChange} />
            <InputFieldRegister label="Cliente" name="cliente" value={formData.cliente} onChange={handleChange} />
            <InputFieldRegister label="Destino" name="destino" value={formData.destino} onChange={handleChange} />
            <InputFieldRegister label="Proyecto" name="proyecto" required value={formData.proyecto} onChange={handleChange} />
            <InputFieldRegister label="Responsable" name="responsable" required value={formData.responsable} onChange={handleChange} />
            <InputFieldRegister label="Fecha RFQ" name="fechaRfq" type="date" required value={formData.fechaRfq} onChange={handleChange} />
            <InputFieldRegister label="SOP (AAAA)" name="sop" type="text" value={formData.sop} onChange={handleChange} />
            <InputFieldRegister label="Duración" name="duracion" value={formData.duracion} onChange={handleChange} />
             <div>
                <label htmlFor="estado" className="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Estado</label>
                <select id="estado" name="estado" value={formData.estado} onChange={handleChange} className="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">
                    <option value="">-- Seleccionar Estado --</option>
                    {statuses.map(status => (
                        <option key={status.id} value={status.name}>{status.name}</option>
                    ))}
                </select>
            </div>
            <InputFieldRegister label="Vol Pico (Opcional)" name="volPico" type="number" value={formData.volPico} onChange={handleChange} />
            <InputFieldRegister label="Vol Total (Opcional)" name="volTot" type="number" value={formData.volTot} onChange={handleChange} />
        </div>
        <div className="flex justify-end pt-4">
            <button type="button" onClick={onClose} className="text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-blue-300 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-500 dark:hover:text-white dark:hover:bg-gray-600 dark:focus:ring-gray-600 mr-2">
                Cancelar
            </button>
            <button type="submit" className="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
                Registrar
            </button>
        </div>
      </form>
    </Modal>
  );
};

// --- Inlined from components/OfferSearchInput.tsx ---
const OfferSearchInput = ({ offers, selectedOffer, onOfferSelect, label, placeholder }) => {
  const { useState, useMemo, useRef, useEffect } = React;
  const [searchTerm, setSearchTerm] = useState('');
  const [isDropdownOpen, setIsDropdownOpen] = useState(false);
  const searchContainerRef = useRef(null);

  useEffect(() => {
    setSearchTerm(selectedOffer ? `${selectedOffer.id} - ${selectedOffer.proyecto}` : '');
  }, [selectedOffer]);
  
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (searchContainerRef.current && !searchContainerRef.current.contains(event.target)) {
        setIsDropdownOpen(false);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, []);

  const filteredOffers = useMemo(() => {
    if (!searchTerm) return [];
    if (selectedOffer && `${selectedOffer.id} - ${selectedOffer.proyecto}` === searchTerm) return [];

    return offers.filter(
      (offer) =>
        offer.id.toLowerCase().includes(searchTerm.toLowerCase()) ||
        offer.proyecto.toLowerCase().includes(searchTerm.toLowerCase())
    );
  }, [searchTerm, offers, selectedOffer]);

  const handleInputChange = (e) => {
    setSearchTerm(e.target.value);
    onOfferSelect(null);
    setIsDropdownOpen(true);
  };

  const handleOfferClick = (offer) => {
    onOfferSelect(offer);
    setSearchTerm(`${offer.id} - ${offer.proyecto}`);
    setIsDropdownOpen(false);
  };

  return (
    <div className="relative" ref={searchContainerRef}>
      <label htmlFor="offer-search-input" className="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
        {label} <span className="text-red-500">*</span>
      </label>
      <div className="relative">
        <div className="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
          <SearchIcon className="w-5 h-5 text-gray-500 dark:text-gray-400" />
        </div>
        <input
          type="text"
          id="offer-search-input"
          value={searchTerm}
          onChange={handleInputChange}
          onFocus={() => setIsDropdownOpen(true)}
          required
          autoComplete="off"
          className="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-10 p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"
          placeholder={placeholder}
        />
      </div>

      {isDropdownOpen && searchTerm && (!selectedOffer || searchTerm !== `${selectedOffer.id} - ${selectedOffer.proyecto}`) && (
        <ul className="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto dark:bg-gray-700 dark:border-gray-600">
          {filteredOffers.length > 0 ? (
            filteredOffers.map((offer) => (
              <li
                key={offer.id}
                onClick={() => handleOfferClick(offer)}
                className="px-4 py-2 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 text-gray-900 dark:text-white"
              >
                {offer.id} - {offer.proyecto}
              </li>
            ))
          ) : (
            <li className="px-4 py-2 text-gray-500 dark:text-gray-400">
              No se encontraron ofertas.
            </li>
          )}
        </ul>
      )}
    </div>
  );
};

// --- Inlined from components/UpdateOfferModal.tsx ---
const UpdateOfferModal = ({ isOpen, onClose, onSubmit, offers }) => {
  const { useState, useEffect } = React;
  const [selectedOffer, setSelectedOffer] = useState(null);
  const [comentario, setComentario] = useState('');
  const [error, setError] = useState('');

  useEffect(() => {
    if (!isOpen) {
        setSelectedOffer(null);
        setComentario('');
        setError('');
    }
  }, [isOpen]);

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!selectedOffer) {
      setError("Por favor, busque y seleccione una oferta válida.");
      return;
    }
     if (!comentario.trim()) {
      setError("Por favor, añada un comentario.");
      return;
    }

    onSubmit({
      offerId: selectedOffer.id,
      fechaAct: new Date().toISOString().split('T')[0],
      comentario,
    });
    
    onClose();
  };
  
  return (
    <Modal isOpen={isOpen} onClose={onClose} title="Actualizar Oferta (Añadir Seguimiento)">
      <form onSubmit={handleSubmit} className="space-y-6">
        <div>
           <OfferSearchInput
              offers={offers}
              selectedOffer={selectedOffer}
              onOfferSelect={(offer) => {
                setSelectedOffer(offer);
                if (error) setError('');
              }}
              label="Buscar y Seleccionar Nº Oferta"
              placeholder="Escriba Nº Oferta o Proyecto..."
            />
            {error && <p className="mt-2 text-sm text-red-600 dark:text-red-500">{error}</p>}
        </div>
        <div>
          <label htmlFor="comentario" className="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
            Comentario Seguimiento <span className="text-red-500">*</span>
          </label>
          <textarea
            id="comentario"
            name="comentario"
            rows={4}
            value={comentario}
            onChange={(e) => setComentario(e.target.value)}
            required
            disabled={!selectedOffer}
            className="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white disabled:bg-gray-200 dark:disabled:bg-gray-600"
            placeholder={selectedOffer ? "Escriba su comentario aquí..." : "Seleccione una oferta para habilitar esta área"}
          ></textarea>
        </div>
         <div className="flex justify-end pt-4">
            <button type="button" onClick={onClose} className="text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-blue-300 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-500 dark:hover:text-white dark:hover:bg-gray-600 dark:focus:ring-gray-600 mr-2">
                Cancelar
            </button>
            <button type="submit" className="text-white bg-green-700 hover:bg-green-800 focus:ring-4 focus:outline-none focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-green-600 dark:hover:bg-green-700 dark:focus:ring-green-800 disabled:opacity-50" disabled={!selectedOffer}>
                Añadir Comentario
            </button>
        </div>
      </form>
    </Modal>
  );
};

// --- Inlined from components/OfferTable.tsx ---
const OfferTable = ({ 
    offers, 
    followUps, 
    statuses, 
    filters,
    onFilterChange,
    onClearFilters,
    onUpdateOfferStatus, 
    onEditOffer, 
    onDeleteOffer 
}) => {
  const { useMemo } = React;
  
  const formatDate = (dateString) => {
    if (!dateString) return '-';
    return new Date(dateString).toLocaleDateString('es-ES', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
    });
  };

  const getTextColorForBackground = (hexColor) => {
      if (!hexColor || hexColor.length < 7) return '#000000';
      const r = parseInt(hexColor.slice(1, 3), 16);
      const g = parseInt(hexColor.slice(3, 5), 16);
      const b = parseInt(hexColor.slice(5, 7), 16);
      const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
      return luminance > 0.5 ? '#000000' : '#FFFFFF';
  };
  
  const getLatestFollowUp = (offerId) => {
    const offerFollowUps = followUps
      .filter((f) => f.offerId === offerId)
      .sort((a, b) => new Date(b.fechaAct).getTime() - new Date(a.fechaAct).getTime());
    return offerFollowUps[0]?.comentario || 'N/A';
  };
  
  const statusColorMap = useMemo(() => new Map(statuses.map(s => [s.name, s.color])), [statuses]);

  const uniqueValues = useMemo(() => {
    const unique = {
        cliente: new Set(),
        responsable: new Set(),
    };
    offers.forEach(offer => {
        if(offer.cliente) unique.cliente.add(offer.cliente);
        if(offer.responsable) unique.responsable.add(offer.responsable);
    });
    return {
        cliente: Array.from(unique.cliente).sort(),
        responsable: Array.from(unique.responsable).sort(),
    };
  }, [offers]);

  const FilterInput = ({ column }) => (
    <input
      type="text"
      value={filters[column] || ''}
      onChange={(e) => onFilterChange(column, e.target.value)}
      className="w-full text-xs p-1 border border-gray-300 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-1 focus:ring-blue-500"
    />
  );

  const FilterSelect = ({ column, options }) => (
    <select
        value={filters[column] || ''}
        onChange={(e) => onFilterChange(column, e.target.value)}
        className="w-full text-xs p-1 border border-gray-300 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-1 focus:ring-blue-500"
    >
        <option value="">Todos</option>
        {options.map(opt => <option key={opt} value={opt}>{opt}</option>)}
    </select>
  );

  return (
    <div className="bg-white dark:bg-gray-800 shadow-lg rounded-lg p-6">
      <div className="flex justify-between items-center mb-4">
        <h2 className="text-xl font-bold text-gray-800 dark:text-white">Listado de Ofertas</h2>
         <button onClick={onClearFilters} className="flex items-center text-sm text-blue-600 dark:text-blue-400 hover:underline">
            <FilterClearIcon className="w-4 h-4 mr-1" />
            Limpiar Filtros
        </button>
      </div>
       <div className="overflow-auto max-h-[36rem]">
        <table className="w-full text-sm text-left text-gray-500 dark:text-gray-400">
            <thead className="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400 sticky top-0 z-10">
            <tr>
              <th scope="col" className="px-6 py-3">Nº Oferta</th>
              <th scope="col" className="px-6 py-3">Estado</th>
              <th scope="col" className="px-6 py-3">Cliente</th>
              <th scope="col" className="px-6 py-3">Destino</th>
              <th scope="col" className="px-6 py-3">Proyecto</th>
              <th scope="col" className="px-6 py-3">Fecha RFQ</th>
              <th scope="col" className="px-6 py-3">Responsable</th>
              <th scope="col" className="px-6 py-3">Ult Act</th>
              <th scope="col" className="px-6 py-3">Vol Pico</th>
              <th scope="col" className="px-6 py-3">Vol Tot</th>
              <th scope="col" className="px-6 py-3">SOP</th>
              <th scope="col" className="px-6 py-3">Duración</th>
              <th scope="col" className="px-6 py-3">Comentarios</th>
              <th scope="col" className="px-6 py-3">Acciones</th>
            </tr>
            <tr className="bg-gray-50 dark:bg-gray-700">
                <th className="px-2 py-1"><FilterInput column="id"/></th>
                <th className="px-2 py-1">
                    <select
                        value={filters.estado || ''}
                        onChange={(e) => onFilterChange('estado', e.target.value)}
                        className="w-full text-xs p-1 border border-gray-300 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-1 focus:ring-blue-500"
                    >
                        <option value="">Todos</option>
                        {statuses.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                    </select>
                </th>
                <th className="px-2 py-1"><FilterSelect column="cliente" options={uniqueValues.cliente} /></th>
                <th className="px-2 py-1"><FilterInput column="destino"/></th>
                <th className="px-2 py-1"><FilterInput column="proyecto"/></th>
                <th className="px-2 py-1"><FilterInput column="fechaRfq"/></th>
                <th className="px-2 py-1"><FilterSelect column="responsable" options={uniqueValues.responsable} /></th>
                <th className="px-2 py-1"><FilterInput column="ultAct"/></th>
                <th className="px-2 py-1"><FilterInput column="volPico"/></th>
                <th className="px-2 py-1"><FilterInput column="volTot"/></th>
                <th className="px-2 py-1"><FilterInput column="sop"/></th>
                <th className="px-2 py-1"><FilterInput column="duracion"/></th>
                <th className="px-2 py-1"></th>
                <th className="px-2 py-1"></th>
            </tr>
          </thead>
          <tbody>
            {offers.length > 0 ? (
                offers.map((offer) => {
                    const statusColor = statusColorMap.get(offer.estado) || '#FFFFFF';
                    const textColor = getTextColorForBackground(statusColor);
                    return (
                      <tr key={offer.id} className="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                        <td className="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">{offer.id}</td>
                        <td className="px-6 py-4">
                            <select 
                                value={offer.estado}
                                onChange={(e) => onUpdateOfferStatus(offer.id, e.target.value)}
                                style={{ backgroundColor: statusColor, color: textColor }}
                                className="px-2 py-1 text-xs font-medium rounded-full border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 appearance-none bg-transparent"
                            >
                                {statuses.map(status => (
                                    <option key={status.id} value={status.name} style={{backgroundColor: '#FFFFFF', color: '#000000'}}>{status.name}</option>
                                ))}
                            </select>
                        </td>
                        <td className="px-6 py-4">{offer.cliente}</td>
                        <td className="px-6 py-4">{offer.destino}</td>
                        <td className="px-6 py-4">{offer.proyecto}</td>
                        <td className="px-6 py-4">{formatDate(offer.fechaRfq)}</td>
                        <td className="px-6 py-4">{offer.responsable}</td>
                        <td className="px-6 py-4">{formatDate(offer.ultAct)}</td>
                        <td className="px-6 py-4 text-right">{offer.volPico?.toLocaleString('es-ES') || '-'}</td>
                        <td className="px-6 py-4 text-right">{offer.volTot?.toLocaleString('es-ES') || '-'}</td>
                        <td className="px-6 py-4">{offer.sop}</td>
                        <td className="px-6 py-4">{offer.duracion}</td>
                        <td className="px-6 py-4 max-w-xs truncate" title={getLatestFollowUp(offer.id)}>
                            {getLatestFollowUp(offer.id)}
                        </td>
                        <td className="px-6 py-4">
                            <div className="flex items-center space-x-3">
                                <button onClick={() => onEditOffer(offer)} className="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300" aria-label={`Editar oferta ${offer.id}`}>
                                    <EditIcon className="w-5 h-5" />
                                </button>
                                <button onClick={() => onDeleteOffer(offer)} className="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300" aria-label={`Eliminar oferta ${offer.id}`}>
                                    <TrashIcon className="w-5 h-5" />
                                </button>
                            </div>
                        </td>
                      </tr>
                    )
                })
            ) : (
                <tr>
                    <td colSpan={14} className="text-center py-10">
                        <p className="text-gray-500 dark:text-gray-400">No se encontraron ofertas que coincidan con los filtros.</p>
                    </td>
                </tr>
            )}
          </tbody>
        </table>
       </div>
    </div>
  );
};

// --- Inlined from components/HistoryView.tsx ---
const HistoryView = ({ offers, followUps, onEditFollowUp, onDeleteFollowUp }) => {
  const { useState, useMemo, useEffect } = React;
  const [selectedOffer, setSelectedOffer] = useState(null);
  
  const formatDate = (dateString) => {
    if (!dateString) return '-';
    return new Date(dateString).toLocaleDateString('es-ES', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
    });
  };

  useEffect(() => {
    if (selectedOffer && !offers.some(o => o.id === selectedOffer.id)) {
      setSelectedOffer(null);
    }
  }, [offers, selectedOffer]);

  const filteredHistory = useMemo(() => {
    if (!selectedOffer) return [];
    return followUps
      .filter((f) => f.offerId === selectedOffer.id)
      .sort((a, b) => new Date(b.fechaAct).getTime() - new Date(a.fechaAct).getTime());
  }, [selectedOffer, followUps]);
  
  return (
    <div className="bg-white dark:bg-gray-800 shadow-lg rounded-lg p-6">
        <h2 className="text-xl font-bold mb-4 text-gray-800 dark:text-white">Histórico de Seguimiento</h2>
        <div className="mb-4">
            <OfferSearchInput 
                offers={offers}
                selectedOffer={selectedOffer}
                onOfferSelect={setSelectedOffer}
                label="Seleccione Nº Oferta para ver su histórico:"
                placeholder="Escriba Nº Oferta o Proyecto..."
            />
        </div>

        {selectedOffer && (
             <div className="overflow-x-auto">
                <table className="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                     <thead className="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                        <tr>
                            <th scope="col" className="px-6 py-3">Nº Oferta</th>
                            <th scope="col" className="px-6 py-3">Proyecto</th>
                            <th scope="col" className="px-6 py-3">Fecha Act.</th>
                            <th scope="col" className="px-6 py-3">Comentario Seguimiento</th>
                            <th scope="col" className="px-6 py-3">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {filteredHistory.length > 0 ? (
                            filteredHistory.map(item => (
                                <tr key={item.id} className="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                                    <td className="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">{item.offerId}</td>
                                    <td className="px-6 py-4">{selectedOffer?.proyecto}</td>
                                    <td className="px-6 py-4">{formatDate(item.fechaAct)}</td>
                                    <td className="px-6 py-4">{item.comentario}</td>
                                    <td className="px-6 py-4">
                                        <div className="flex items-center space-x-3">
                                            <button onClick={() => onEditFollowUp(item)} className="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300" aria-label="Editar comentario">
                                                <EditIcon className="w-5 h-5" />
                                            </button>
                                            <button onClick={() => onDeleteFollowUp(item.id)} className="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300" aria-label="Eliminar comentario">
                                                <TrashIcon className="w-5 h-5" />
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            ))
                        ) : (
                            <tr>
                                <td colSpan={5} className="text-center py-4">No hay historial de seguimiento para esta oferta.</td>
                            </tr>
                        )}
                    </tbody>
                </table>
             </div>
        )}
    </div>
  );
};

// --- Inlined from components/OfferChart.tsx ---
const OfferChart = ({ offers }) => {
  const { useMemo } = React;
  const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = recharts;
  
  const COLORS = ['#3b82f6', '#10b981', '#ef4444', '#f97316', '#8b5cf6', '#ec4899'];

  const { chartData, uniqueYears } = useMemo(() => {
    const dataByYearMonth = {};
    const years = new Set();

    offers.forEach(offer => {
      if (offer.fechaRfq) {
        const offerDate = new Date(offer.fechaRfq);
        const year = offerDate.getFullYear().toString();
        const month = offerDate.getMonth();
        
        years.add(year);
        
        if (!dataByYearMonth[year]) {
          dataByYearMonth[year] = {};
        }
        if (!dataByYearMonth[year][month]) {
          dataByYearMonth[year][month] = 0;
        }
        dataByYearMonth[year][month]++;
      }
    });

    const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
    const sortedYears = Array.from(years).sort((a, b) => parseInt(a) - parseInt(b));

    const finalChartData = monthNames.map((monthName, index) => {
      const monthData = { name: monthName };
      sortedYears.forEach(year => {
        monthData[year] = dataByYearMonth[year]?.[index] || 0;
      });
      return monthData;
    });

    return { chartData: finalChartData, uniqueYears: sortedYears };
  }, [offers]);

  return (
    <div className="bg-white dark:bg-gray-800 shadow-lg rounded-lg p-6">
      <h2 className="text-xl font-bold mb-4 text-gray-800 dark:text-white">Evolución Anual de Ofertas por Mes</h2>
      <div style={{ width: '100%', height: 400 }}>
        <ResponsiveContainer>
          <LineChart
            data={chartData}
            margin={{
              top: 5,
              right: 30,
              left: 20,
              bottom: 5,
            }}
          >
            <CartesianGrid strokeDasharray="3 3" />
            <XAxis dataKey="name" />
            <YAxis allowDecimals={false} />
            <Tooltip
              contentStyle={{
                backgroundColor: 'rgba(255, 255, 255, 0.9)',
                border: '1px solid #ccc',
                color: '#333'
              }}
            />
            <Legend />
            {uniqueYears.map((year, index) => (
               <Line 
                  key={year} 
                  type="monotone" 
                  dataKey={year} 
                  stroke={COLORS[index % COLORS.length]} 
                  strokeWidth={2}
                  activeDot={{ r: 8 }}
                />
            ))}
          </LineChart>
        </ResponsiveContainer>
      </div>
    </div>
  );
};

// --- Inlined from components/EditFollowUpModal.tsx ---
const EditFollowUpModal = ({ isOpen, onClose, onSubmit, followUp }) => {
  const { useState, useEffect } = React;
  const [comentario, setComentario] = useState('');

  useEffect(() => {
    if (followUp) {
      setComentario(followUp.comentario);
    }
  }, [followUp]);

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!comentario || !followUp) {
        alert("El comentario no puede estar vacío.");
        return;
    }

    onSubmit({
      ...followUp,
      comentario,
    });
    onClose();
  };
  
  if (!followUp) return null;

  return (
    <Modal isOpen={isOpen} onClose={onClose} title={`Editar Seguimiento - Oferta ${followUp.offerId}`}>
      <form onSubmit={handleSubmit} className="space-y-6">
        <div>
          <label htmlFor="comentario-edit" className="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
            Comentario Seguimiento <span className="text-red-500">*</span>
          </label>
          <textarea
            id="comentario-edit"
            name="comentario"
            rows={4}
            value={comentario}
            onChange={(e) => setComentario(e.target.value)}
            required
            className="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"
            placeholder="Escriba su comentario aquí..."
          ></textarea>
        </div>
         <div className="flex justify-end pt-4">
            <button type="button" onClick={onClose} className="text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-blue-300 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-500 dark:hover:text-white dark:hover:bg-gray-600 dark:focus:ring-gray-600 mr-2">
                Cancelar
            </button>
            <button type="submit" className="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
                Guardar Cambios
            </button>
        </div>
      </form>
    </Modal>
  );
};

// --- Inlined from components/ConfigurationView.tsx ---
const ConfigurationView = ({ statuses, onAddStatus, onDeleteStatus }) => {
  const { useState } = React;
  const [newStatusName, setNewStatusName] = useState('');
  const [newStatusColor, setNewStatusColor] = useState('#cccccc');

  const handleAddStatus = (e) => {
    e.preventDefault();
    if (!newStatusName) {
      alert('El nombre del estado no puede estar vacío.');
      return;
    }
    if (statuses.some(s => s.name.toLowerCase() === newStatusName.toLowerCase())) {
        alert('Este estado ya existe.');
        return;
    }

    onAddStatus({ name: newStatusName, color: newStatusColor });
    setNewStatusName('');
    setNewStatusColor('#cccccc');
  };

  return (
    <div className="bg-white dark:bg-gray-800 shadow-lg rounded-lg p-6 space-y-8">
      <div>
        <h2 className="text-xl font-bold mb-4 text-gray-800 dark:text-white">Gestionar Estados de Oferta</h2>
        <form onSubmit={handleAddStatus} className="flex flex-col md:flex-row items-end gap-4 p-4 border rounded-lg dark:border-gray-700">
          <div className="flex-grow w-full">
            <label htmlFor="status-name" className="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
              Nombre del Nuevo Estado
            </label>
            <input
              type="text"
              id="status-name"
              value={newStatusName}
              onChange={(e) => setNewStatusName(e.target.value)}
              className="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"
              placeholder="Ej: En Negociación"
            />
          </div>
          <div className="w-full md:w-auto">
            <label htmlFor="status-color" className="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
              Color
            </label>
            <input
              type="color"
              id="status-color"
              value={newStatusColor}
              onChange={(e) => setNewStatusColor(e.target.value)}
              className="p-1 h-10 w-full md:w-14 block bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 cursor-pointer rounded-lg disabled:opacity-50 disabled:pointer-events-none"
            />
          </div>
          <button
            type="submit"
            className="w-full md:w-auto text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800"
          >
            Añadir Estado
          </button>
        </form>
      </div>

      <div>
        <h3 className="text-lg font-semibold mb-2 text-gray-800 dark:text-white">Estados Actuales</h3>
        <ul className="space-y-2">
          {statuses.map(status => (
            <li key={status.id} className="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
              <div className="flex items-center gap-3">
                <span className="block w-5 h-5 rounded-full" style={{ backgroundColor: status.color }}></span>
                <span className="text-gray-900 dark:text-white">{status.name}</span>
              </div>
              <button
                onClick={() => onDeleteStatus(status.id)}
                className="text-red-500 hover:text-red-700 dark:hover:text-red-400"
                aria-label={`Eliminar ${status.name}`}
              >
                <TrashIcon />
              </button>
            </li>
          ))}
        </ul>
      </div>
    </div>
  );
};

// --- Inlined from components/EditOfferModal.tsx ---
const InputFieldEdit = ({ label, name, type = 'text', required = false, value, onChange, disabled = false }) => (
    <div>
      <label htmlFor={name} className="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
        {label} {required && <span className="text-red-500">*</span>}
      </label>
      <input
        type={type}
        id={name}
        name={name}
        value={value}
        onChange={onChange}
        required={required}
        disabled={disabled}
        className="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white disabled:bg-gray-200 dark:disabled:bg-gray-500 dark:disabled:text-gray-400"
      />
    </div>
);

const EditOfferModal = ({ isOpen, onClose, onSubmit, statuses, offer }) => {
  const { useState, useEffect } = React;
  const getInitialState = () => ({
    id: '',
    estado: '',
    cliente: '',
    destino: '',
    proyecto: '',
    fechaRfq: '',
    responsable: '',
    volPico: '',
    volTot: '',
    sop: '',
    duracion: '',
  });

  const [formData, setFormData] = useState(getInitialState());

  useEffect(() => {
    if (offer) {
      setFormData({
        id: offer.id,
        estado: offer.estado || '',
        cliente: offer.cliente || '',
        destino: offer.destino || '',
        proyecto: offer.proyecto,
        fechaRfq: offer.fechaRfq,
        responsable: offer.responsable,
        sop: offer.sop || '',
        duracion: offer.duracion || '',
        volPico: offer.volPico?.toString() || '',
        volTot: offer.volTot?.toString() || '',
      });
    } else if (!isOpen) {
        setFormData(getInitialState());
    }
  }, [offer, isOpen]);


  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData((prev) => ({ ...prev, [name]: value }));
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!formData.id || !formData.proyecto || !formData.fechaRfq || !formData.responsable) {
        alert("Por favor, rellene los campos obligatorios: Nº Oferta, Proyecto, Fecha RFQ y Responsable.");
        return;
    }
    
    onSubmit({
      id: formData.id,
      estado: formData.estado,
      cliente: formData.cliente,
      destino: formData.destino,
      proyecto: formData.proyecto,
      fechaRfq: formData.fechaRfq,
      responsable: formData.responsable,
      sop: formData.sop,
      duracion: formData.duracion,
      volPico: formData.volPico ? Number(formData.volPico) : undefined,
      volTot: formData.volTot ? Number(formData.volTot) : undefined,
    });
    onClose();
  };

  return (
    <Modal isOpen={isOpen} onClose={onClose} title="Editar Oferta">
      <form onSubmit={handleSubmit} className="space-y-4">
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <InputFieldEdit label="Nº Oferta" name="id" required value={formData.id} onChange={handleChange} disabled={true} />
            <InputFieldEdit label="Cliente" name="cliente" value={formData.cliente} onChange={handleChange} />
            <InputFieldEdit label="Destino" name="destino" value={formData.destino} onChange={handleChange} />
            <InputFieldEdit label="Proyecto" name="proyecto" required value={formData.proyecto} onChange={handleChange} />
            <InputFieldEdit label="Responsable" name="responsable" required value={formData.responsable} onChange={handleChange} />
            <InputFieldEdit label="Fecha RFQ" name="fechaRfq" type="date" required value={formData.fechaRfq} onChange={handleChange} />
            <InputFieldEdit label="SOP (AAAA)" name="sop" type="text" value={formData.sop} onChange={handleChange} />
            <InputFieldEdit label="Duración" name="duracion" value={formData.duracion} onChange={handleChange} />
             <div>
                <label htmlFor="estado" className="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Estado</label>
                <select id="estado" name="estado" value={formData.estado} onChange={handleChange} className="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">
                    <option value="">-- Seleccionar Estado --</option>
                    {statuses.map(status => (
                        <option key={status.id} value={status.name}>{status.name}</option>
                    ))}
                </select>
            </div>
            <InputFieldEdit label="Vol Pico (Opcional)" name="volPico" type="number" value={formData.volPico} onChange={handleChange} />
            <InputFieldEdit label="Vol Total (Opcional)" name="volTot" type="number" value={formData.volTot} onChange={handleChange} />
        </div>
        <div className="flex justify-end pt-4">
            <button type="button" onClick={onClose} className="text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-blue-300 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-500 dark:hover:text-white dark:hover:bg-gray-600 dark:focus:ring-gray-600 mr-2">
                Cancelar
            </button>
            <button type="submit" className="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
                Guardar Cambios
            </button>
        </div>
      </form>
    </Modal>
  );
};

// --- Inlined from components/ImportCSVModal.tsx ---
const ImportCSVModal = ({ isOpen, onClose, onSubmit, existingOfferIds }) => {
  const { useState, useMemo } = React;
  const [parsedOffers, setParsedOffers] = useState([]);
  const [fileName, setFileName] = useState('');
  const [error, setError] = useState('');

  const headerMapping = {
    id: ['id', 'nº oferta', 'no. oferta', 'no oferta', 'numero oferta'],
    estado: ['estado'],
    cliente: ['cliente'],
    destino: ['destino'],
    proyecto: ['proyecto'],
    fechaRfq: ['fecharfq', 'fecha rfq'],
    responsable: ['responsable'],
    sop: ['sop'],
    duracion: ['duracion', 'duración'],
    volPico: ['volpico', 'vol pico'],
    volTot: ['voltot', 'vol total'],
  };

  const canonicalRequiredHeaders = ['id', 'proyecto', 'fechaRfq', 'responsable'];

  const handleClose = () => {
    setParsedOffers([]);
    setFileName('');
    setError('');
    onClose();
  };

  const handleFileChange = (event) => {
    const file = event.target.files?.[0];
    if (!file) return;

    setFileName(file.name);
    setParsedOffers([]);
    setError('');

    const reader = new FileReader();
    reader.onload = (e) => {
      let text = e.target?.result;
      if (!text) {
          setError('No se pudo leer el contenido del archivo.');
          return;
      }
      
      if (text.charCodeAt(0) === 0xFEFF) {
        text = text.substring(1);
      }

      const lines = text.split(/\r\n|\n/).filter(line => line.trim() !== '');

      if (lines.length < 2) {
        setError('El archivo CSV está vacío o solo contiene la cabecera.');
        return;
      }
      
      const headerLine = lines[0];
      const delimiter = headerLine.includes(';') ? ';' : ',';
      const csvHeaders = headerLine.split(delimiter).map(h => h.trim().toLowerCase());

      const columnIndexMap = {};
      const foundHeaders = new Set();

      csvHeaders.forEach((csvHeader, index) => {
          for (const canonicalHeader in headerMapping) {
              const variations = headerMapping[canonicalHeader] || [];
              if (variations.includes(csvHeader)) {
                  columnIndexMap[canonicalHeader] = index;
                  foundHeaders.add(canonicalHeader);
                  break; 
              }
          }
      });
      
      const missingHeaders = canonicalRequiredHeaders.filter(h => !foundHeaders.has(h));
      if (missingHeaders.length > 0) {
        setError(`Faltan columnas requeridas o sus nombres no se reconocen. Columnas no encontradas: ${missingHeaders.join(', ')}. Por favor, revise las cabeceras de su archivo.`);
        return;
      }

      const offers = [];
      const newOfferIdsInFile = new Set();
      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(delimiter);
        const rowData = {};
        
        for (const canonicalHeader in columnIndexMap) {
            const index = columnIndexMap[canonicalHeader];
            if (index !== undefined && index < values.length) {
                let value = values[index]?.trim() || '';
                if (value.startsWith('"') && value.endsWith('"')) {
                    value = value.substring(1, value.length - 1).trim();
                }
                rowData[canonicalHeader] = value;
            }
        }
        
        const missingField = canonicalRequiredHeaders.find(field => !rowData[field]);
        if (missingField) {
          offers.push({ ...rowData, id: rowData.id || `Fila ${i+1}`, status: 'error', error: `Falta el campo obligatorio: ${missingField}` });
          continue;
        }

        const offerId = rowData.id;
        if (offerId.includes('/')) {
            offers.push({ ...rowData, id: offerId, status: 'error', error: `Nº Oferta inválido: no puede contener '/'.` });
            continue;
        }
        
        let isoDate = '';
        const rawDate = rowData.fechaRfq;
        const dateParts = rawDate.split('/');
        if (dateParts.length === 3 && dateParts[0].length === 2 && dateParts[1].length === 2 && dateParts[2].length === 4) {
            const [day, month, year] = dateParts;
            isoDate = `${year}-${month}-${day}`;
            if (isNaN(new Date(isoDate).getTime())) {
                offers.push({ ...rowData, status: 'error', error: `Fecha RFQ inválida: '${rawDate}'.` });
                continue;
            }
        } else {
            offers.push({ ...rowData, status: 'error', error: `Formato de fechaRfq incorrecto para '${rawDate}'. Use DD/MM/AAAA.` });
            continue;
        }

        const parseNumber = (value) => {
            if (value === undefined || value.trim() === '') return undefined;
            const cleanedValue = value.trim().replace(/\./g, '').replace(',', '.');
            const num = parseFloat(cleanedValue);
            return isNaN(num) ? undefined : num;
        };

        const offer = {
            id: offerId,
            estado: rowData.estado || '',
            cliente: rowData.cliente || '',
            destino: rowData.destino || '',
            proyecto: rowData.proyecto,
            fechaRfq: isoDate,
            responsable: rowData.responsable,
            sop: rowData.sop || '',
            duracion: rowData.duracion || '',
            volPico: parseNumber(rowData.volPico),
            volTot: parseNumber(rowData.volTot),
        };

        if (existingOfferIds.has(offer.id)) {
            offers.push({ ...offer, status: 'duplicate' });
        } else if (newOfferIdsInFile.has(offer.id)) {
            offers.push({ ...offer, status: 'error', error: 'Nº Oferta duplicado dentro del archivo CSV.' });
        } else {
            offers.push({ ...offer, status: 'new' });
            newOfferIdsInFile.add(offer.id);
        }
      }
      setParsedOffers(offers);
    };

    reader.onerror = () => {
      setError('Error al leer el archivo.');
    };

    reader.readAsText(file);
  };
  
  const handleSubmit = () => {
      const offersToSubmit = parsedOffers
        .filter(o => o.status === 'new')
        .map(({status, error, ...rest}) => rest);
      
      if(offersToSubmit.length > 0) {
          onSubmit(offersToSubmit);
      }
      handleClose();
  }

  const { newCount, duplicateCount, errorCount } = useMemo(() => {
    return parsedOffers.reduce((acc, offer) => {
        if(offer.status === 'new') acc.newCount++;
        else if(offer.status === 'duplicate') acc.duplicateCount++;
        else if(offer.status === 'error') acc.errorCount++;
        return acc;
    }, { newCount: 0, duplicateCount: 0, errorCount: 0});
  }, [parsedOffers]);


  return (
    <Modal isOpen={isOpen} onClose={handleClose} title="Importar Ofertas desde CSV">
        <div className="space-y-6">
            <div className="p-4 border border-dashed rounded-lg dark:border-gray-600 space-y-2">
                <h3 className="font-semibold text-gray-800 dark:text-gray-200">Instrucciones</h3>
                <p className="text-sm text-gray-600 dark:text-gray-400">
                    El archivo CSV debe contener columnas para los campos requeridos (ej: Nº Oferta, Proyecto, Responsable, etc.). El sistema es flexible con los nombres y el orden.
                </p>
                <p className="text-sm text-gray-600 dark:text-gray-400">
                    La fecha <code className="text-xs bg-gray-100 dark:bg-gray-700 p-1 rounded">fechaRfq</code> debe estar en formato DD/MM/AAAA. Las ofertas con un Nº Oferta (id) que ya exista en el sistema serán omitidas.
                </p>
            </div>

            <div>
                <label className="block mb-2 text-sm font-medium text-gray-900 dark:text-white" htmlFor="file_input">Subir archivo</label>
                <input 
                    className="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 dark:text-gray-400 focus:outline-none dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400" 
                    id="file_input" 
                    type="file"
                    accept=".csv"
                    onChange={handleFileChange}
                />
                 {fileName && <p className="mt-1 text-sm text-gray-500 dark:text-gray-300">{fileName}</p>}
                 {error && <p className="mt-2 text-sm text-red-600 dark:text-red-500">{error}</p>}
            </div>

            {parsedOffers.length > 0 && (
                <div>
                    <h4 className="font-semibold text-gray-800 dark:text-gray-200 mb-2">Vista Previa de Importación</h4>
                    <p className="text-sm mb-2">
                        <span className="text-green-600 dark:text-green-400 font-medium">{newCount} nuevas</span> | 
                        <span className="text-yellow-600 dark:text-yellow-400 font-medium"> {duplicateCount} duplicadas (se omitirán)</span> |
                        <span className="text-red-600 dark:text-red-500 font-medium"> {errorCount} con errores</span>
                    </p>
                    <div className="max-h-60 overflow-y-auto border rounded-lg dark:border-gray-600">
                        <table className="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                            <thead className="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400 sticky top-0">
                                <tr>
                                    <th scope="col" className="px-4 py-2">Nº Oferta</th>
                                    <th scope="col" className="px-4 py-2">Proyecto</th>
                                    <th scope="col" className="px-4 py-2">Estado Importación</th>
                                </tr>
                            </thead>
                            <tbody>
                                {parsedOffers.map((offer, index) => (
                                    <tr key={index} className="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
                                        <td className="px-4 py-2 font-medium text-gray-900 dark:text-white">{offer.id}</td>
                                        <td className="px-4 py-2">{offer.proyecto}</td>
                                        <td className="px-4 py-2">
                                            {offer.status === 'new' && <span className="px-2 py-1 text-xs font-medium text-green-800 bg-green-100 rounded-full dark:bg-green-900 dark:text-green-300">Nueva</span>}
                                            {offer.status === 'duplicate' && <span className="px-2 py-1 text-xs font-medium text-yellow-800 bg-yellow-100 rounded-full dark:bg-yellow-900 dark:text-yellow-300">Duplicada</span>}
                                            {offer.status === 'error' && <span className="px-2 py-1 text-xs font-medium text-red-800 bg-red-100 rounded-full dark:bg-red-900 dark:text-red-300" title={offer.error}>{offer.error}</span>}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}

            <div className="flex justify-end pt-4 border-t dark:border-gray-700">
                <button type="button" onClick={handleClose} className="text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-blue-300 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-500 dark:hover:text-white dark:hover:bg-gray-600 dark:focus:ring-gray-600 mr-2">
                    Cancelar
                </button>
                <button 
                    type="button" 
                    onClick={handleSubmit}
                    disabled={newCount === 0}
                    className="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800 disabled:opacity-50"
                >
                    <div className="flex items-center">
                        <UploadIcon className="w-4 h-4 mr-2" />
                        Importar {newCount > 0 ? newCount : ''} Ofertas
                    </div>
                </button>
            </div>
        </div>
    </Modal>
  );
};


// --- Main App Component (inlined from App.tsx) ---
const App = () => {
    const { useState, useEffect, useMemo } = React;
    const { collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, query, orderBy, getDoc, setDoc, where, getDocs, writeBatch } = firebase_firestore;

    const [offers, setOffers] = useState([]);
    const [followUps, setFollowUps] = useState([]);
    const [statuses, setStatuses] = useState([]);
    const [isDataLoading, setIsDataLoading] = useState(true);
    const [activeTab, setActiveTab] = useState('offers');
    const [isRegisterModalOpen, setIsRegisterModalOpen] = useState(false);
    const [isUpdateModalOpen, setIsUpdateModalOpen] = useState(false);
    const [isEditFollowUpModalOpen, setIsEditFollowUpModalOpen] = useState(false);
    const [editingFollowUp, setEditingFollowUp] = useState(null);
    const [isEditOfferModalOpen, setIsEditOfferModalOpen] = useState(false);
    const [editingOffer, setEditingOffer] = useState(null);
    const [isImportModalOpen, setIsImportModalOpen] = useState(false);
    const [filters, setFilters] = useState({});
    const [dialog, setDialog] = useState({ isOpen: false, title: '', message: '', isConfirmation: false, onConfirm: null });

    const existingOfferIds = useMemo(() => new Set(offers.map(o => o.id)), [offers]);

    useEffect(() => {
        setIsDataLoading(true);

        const offersQuery = query(collection(db, 'offers'), orderBy('proyecto'));
        const unsubOffers = onSnapshot(offersQuery, (snapshot) => {
            const offersData = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
            setOffers(offersData);
            setIsDataLoading(false);
        }, (error) => {
            console.error("Error fetching offers: ", error);
            setIsDataLoading(false);
        });

        const followUpsQuery = query(collection(db, 'followUps'), orderBy('fechaAct', 'desc'));
        const unsubFollowUps = onSnapshot(followUpsQuery, (snapshot) => {
            const followUpsData = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
            setFollowUps(followUpsData);
        });

        const statusesQuery = query(collection(db, 'statuses'), orderBy('name'));
        const unsubStatuses = onSnapshot(statusesQuery, (snapshot) => {
            const statusesData = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
            setStatuses(statusesData);
        });

        return () => {
            unsubOffers();
            unsubFollowUps();
            unsubStatuses();
        };
    }, []);

    const handleRegisterOffer = async (newOfferData) => {
        const offerRef = doc(db, 'offers', newOfferData.id);
        const docSnap = await getDoc(offerRef);

        if (docSnap.exists()) {
            setDialog({
                isOpen: true,
                title: 'Error al Registrar',
                message: `El número de oferta "${newOfferData.id}" ya existe. Por favor, introduzca un número diferente.`,
                isConfirmation: false,
                onConfirm: null,
            });
            return;
        }

        const offerWithDate = {
            ...newOfferData,
            ultAct: newOfferData.fechaRfq,
        };
        const cleanOffer = Object.fromEntries(Object.entries(offerWithDate).filter(([_, v]) => v !== undefined));
        await setDoc(offerRef, cleanOffer);
    };

    const handleOpenEditOfferModal = (offer) => {
        setEditingOffer(offer);
        setIsEditOfferModalOpen(true);
    };

    const handleEditOffer = async (updatedOfferData) => {
        const offerRef = doc(db, 'offers', updatedOfferData.id);
        const offerWithDate = {
            ...updatedOfferData,
            ultAct: new Date().toISOString().split('T')[0],
        };
        const cleanOffer = Object.fromEntries(Object.entries(offerWithDate).filter(([_, v]) => v !== undefined));
        await updateDoc(offerRef, cleanOffer);
    };

    const handleDeleteOffer = (offer) => {
        setDialog({
            isOpen: true,
            title: 'Confirmar Eliminación de Oferta',
            message: `¿Estás seguro de que quieres eliminar la oferta "${offer.id} - ${offer.proyecto}"? Esta acción no se puede deshacer y también eliminará todo su historial de seguimiento.`,
            isConfirmation: true,
            onConfirm: async () => {
                const followUpsQuery = query(collection(db, 'followUps'), where('offerId', '==', offer.id));
                const followUpsSnapshot = await getDocs(followUpsQuery);
                const batch = writeBatch(db);
                const offerRef = doc(db, 'offers', offer.id);
                batch.delete(offerRef);
                followUpsSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                setDialog({ isOpen: false, title: '', message: '', isConfirmation: false, onConfirm: null });
            }
        });
    };

    const handleUpdateOffer = async (newFollowUpData) => {
        await addDoc(collection(db, 'followUps'), newFollowUpData);
        const offerRef = doc(db, 'offers', newFollowUpData.offerId);
        await updateDoc(offerRef, { ultAct: newFollowUpData.fechaAct });
    };

    const handleEditFollowUp = async (updatedFollowUp) => {
        const followUpRef = doc(db, 'followUps', updatedFollowUp.id);
        await updateDoc(followUpRef, { comentario: updatedFollowUp.comentario });
    };

    const handleDeleteFollowUp = (followUpId) => {
        setDialog({
            isOpen: true,
            title: 'Confirmar Eliminación',
            message: '¿Estás seguro de que quieres eliminar este comentario de seguimiento? Esta acción no se puede deshacer.',
            isConfirmation: true,
            onConfirm: async () => {
                await deleteDoc(doc(db, 'followUps', followUpId));
                setDialog({ isOpen: false, title: '', message: '', isConfirmation: false, onConfirm: null });
            }
        });
    };

    const handleOpenEditFollowUpModal = (followUp) => {
        setEditingFollowUp(followUp);
        setIsEditFollowUpModalOpen(true);
    };

    const handleUpdateOfferStatus = async (offerId, newStatus) => {
        const offerRef = doc(db, 'offers', offerId);
        await updateDoc(offerRef, { estado: newStatus });
    };

    const handleAddStatus = async (newStatusData) => {
        await addDoc(collection(db, 'statuses'), newStatusData);
    };

    const handleDeleteStatus = (statusId) => {
        const statusToDelete = statuses.find(s => s.id === statusId);
        if (!statusToDelete) return;

        const isStatusInUse = offers.some(offer => offer.estado === statusToDelete.name);
        if (isStatusInUse) {
            setDialog({
                isOpen: true,
                title: 'Acción Bloqueada',
                message: `No se puede eliminar el estado "${statusToDelete.name}" porque está siendo utilizado por una o más ofertas.`,
                isConfirmation: false,
                onConfirm: null,
            });
            return;
        }

        setDialog({
            isOpen: true,
            title: 'Confirmar Eliminación',
            message: `¿Estás seguro de que quieres eliminar el estado "${statusToDelete.name}"?`,
            isConfirmation: true,
            onConfirm: async () => {
                await deleteDoc(doc(db, 'statuses', statusId));
                setDialog({ isOpen: false, title: '', message: '', isConfirmation: false, onConfirm: null });
            }
        });
    }

    const handleImportOffers = async (offersToImport) => {
        const batch = writeBatch(db);
        offersToImport.forEach(newOfferData => {
            const offerRef = doc(db, 'offers', newOfferData.id);
            const offerWithDate = { ...newOfferData, ultAct: newOfferData.fechaRfq };
            const cleanOffer = Object.fromEntries(Object.entries(offerWithDate).filter(([_, v]) => v !== undefined));
            batch.set(offerRef, cleanOffer);
        });
        try {
            await batch.commit();
            setDialog({ isOpen: true, title: 'Importación Completada', message: `${offersToImport.length} nueva(s) oferta(s) importada(s) con éxito.`, isConfirmation: false, onConfirm: null });
        } catch (error) {
            console.error('Error al importar ofertas desde CSV:', error);
            setDialog({ isOpen: true, title: 'Error de Importación', message: 'Ocurrió un error al guardar los datos en la base de datos. Por favor, asegúrese de que todos los datos en el archivo CSV son correctos (especialmente los formatos de fecha y números) y vuelva a intentarlo.', isConfirmation: false, onConfirm: null });
        }
    };

    const handleFilterChange = (key, value) => {
        setFilters(prev => ({ ...prev, [key]: value }));
    };

    const clearFilters = () => {
        setFilters({});
    };

    const filteredOffers = useMemo(() => {
        const filtered = offers.filter(offer => {
            return Object.entries(filters).every(([key, value]) => {
                if (!value) return true;
                const offerValue = offer[key];
                if (offerValue === null || offerValue === undefined) return false;
                return String(offerValue).toLowerCase().includes(String(value).toLowerCase());
            });
        });

        // Sort by most recent 'ultAct' date
        return filtered.sort((a, b) => {
            const dateA = a.ultAct ? new Date(a.ultAct).getTime() : 0;
            const dateB = b.ultAct ? new Date(b.ultAct).getTime() : 0;
            return dateB - dateA;
        });
    }, [offers, filters]);

    const getLatestFollowUp = (offerId) => {
        const offerFollowUps = followUps.filter((f) => f.offerId === offerId).sort((a, b) => new Date(b.fechaAct).getTime() - new Date(a.fechaAct).getTime());
        return offerFollowUps[0]?.comentario || '';
    };

    const handleExportCSV = () => {
        if (filteredOffers.length === 0) {
            setDialog({ isOpen: true, title: 'No hay Datos para Exportar', message: "No hay ofertas que coincidan con los filtros actuales para exportar.", isConfirmation: false, onConfirm: null });
            return;
        }
        const headers = ["Nº Oferta", "Estado", "Cliente", "Destino", "Proyecto", "Fecha RFQ", "Responsable", "Ult Act", "Vol Pico", "Vol Tot", "SOP", "Duración", "Último Comentario"];
        const formatDateForCSV = (dateString) => {
            if (!dateString) return '';
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        };
        const escapeCsvField = (field) => {
            const str = String(field ?? '');
            if (str.includes(';') || str.includes('"') || str.includes('\n')) {
                return `"${str.replace(/"/g, '""')}"`;
            }
            return str;
        };
        const csvRows = filteredOffers.map(offer => {
            const latestFollowUp = getLatestFollowUp(offer.id);
            const row = [offer.id, offer.estado, offer.cliente, offer.destino, offer.proyecto, formatDateForCSV(offer.fechaRfq), offer.responsable, formatDateForCSV(offer.ultAct), offer.volPico?.toString().replace('.', ',') || '', offer.volTot?.toString().replace('.', ',') || '', offer.sop, offer.duracion, latestFollowUp];
            return row.map(escapeCsvField).join(';');
        });
        const csvContent = [headers.join(';'), ...csvRows].join('\n');
        const blob = new Blob([`\uFEFF${csvContent}`], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            const today = new Date().toISOString().split('T')[0];
            link.setAttribute("href", url);
            link.setAttribute("download", `export_ofertas_${today}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    };

    if (isDataLoading) {
        return (
            <div className="flex justify-center items-center min-h-screen bg-gray-100 dark:bg-gray-900">
                <p className="text-xl text-gray-800 dark:text-white">Cargando datos...</p>
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">
            <Header onRegisterClick={() => setIsRegisterModalOpen(true)} onUpdateClick={() => setIsUpdateModalOpen(true)} onImportClick={() => setIsImportModalOpen(true)} onExportClick={handleExportCSV} />
            <main className="container mx-auto p-4 space-y-8">
                <div className="mb-8 border-b border-gray-200 dark:border-gray-700">
                    <ul className="flex flex-wrap -mb-px text-sm font-medium text-center text-gray-500 dark:text-gray-400">
                        <li className="mr-2">
                            <button onClick={() => setActiveTab('offers')} className={`inline-flex items-center justify-center p-4 border-b-2 rounded-t-lg group ${activeTab === 'offers' ? 'text-blue-600 border-blue-600 dark:text-blue-500 dark:border-blue-500' : 'border-transparent hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300'}`}>
                                Ofertas
                            </button>
                        </li>
                        <li>
                            <button onClick={() => setActiveTab('config')} className={`inline-flex items-center justify-center p-4 border-b-2 rounded-t-lg group ${activeTab === 'config' ? 'text-blue-600 border-blue-600 dark:text-blue-500 dark:border-blue-500' : 'border-transparent hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300'}`}>
                                <CogIcon className="w-5 h-5 mr-2" />
                                Configuración
                            </button>
                        </li>
                    </ul>
                </div>
                {activeTab === 'offers' && (
                    <div className="space-y-8">
                        <OfferTable offers={filteredOffers} followUps={followUps} statuses={statuses} filters={filters} onFilterChange={handleFilterChange} onClearFilters={clearFilters} onUpdateOfferStatus={handleUpdateOfferStatus} onEditOffer={handleOpenEditOfferModal} onDeleteOffer={handleDeleteOffer} />
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <HistoryView offers={offers} followUps={followUps} onEditFollowUp={handleOpenEditFollowUpModal} onDeleteFollowUp={handleDeleteFollowUp} />
                            <OfferChart offers={offers} />
                        </div>
                    </div>
                )}
                {activeTab === 'config' && (
                    <ConfigurationView statuses={statuses} onAddStatus={handleAddStatus} onDeleteStatus={handleDeleteStatus} />
                )}
            </main>
            <RegisterOfferModal isOpen={isRegisterModalOpen} onClose={() => setIsRegisterModalOpen(false)} onSubmit={handleRegisterOffer} statuses={statuses} />
            <UpdateOfferModal isOpen={isUpdateModalOpen} onClose={() => setIsUpdateModalOpen(false)} onSubmit={handleUpdateOffer} offers={offers} />
            <ImportCSVModal isOpen={isImportModalOpen} onClose={() => setIsImportModalOpen(false)} onSubmit={handleImportOffers} existingOfferIds={existingOfferIds} />
            <EditOfferModal isOpen={isEditOfferModalOpen} onClose={() => setIsEditOfferModalOpen(false)} onSubmit={handleEditOffer} statuses={statuses} offer={editingOffer} />
            <EditFollowUpModal isOpen={isEditFollowUpModalOpen} onClose={() => setIsEditFollowUpModalOpen(false)} onSubmit={handleEditFollowUp} followUp={editingFollowUp} />
            <AlertDialog isOpen={dialog.isOpen} onClose={() => setDialog({ ...dialog, isOpen: false })} onConfirm={dialog.onConfirm} title={dialog.title} message={dialog.message} isConfirmation={dialog.isConfirmation} />
        </div>
    );
}


// --- Inlined from index.tsx ---
import React from 'react';
import ReactDOM from 'react-dom/client';

// Use firebase_firestore alias from import map
import * as firebase_firestore from 'firebase/firestore';
import * as recharts from 'recharts';


const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
}

const root = ReactDOM.createRoot(rootElement);
root.render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);

    </script>
  </body>
</html>